<ion-header>
  <ion-toolbar>
    <ion-title>Panel Administrativo</ion-title>
    <ion-buttons slot="end">
      <ion-chip>
        <ion-icon name="person"></ion-icon>
        <ion-label>{{ user()?.name }}</ion-label>
      </ion-chip>
      <ion-button (click)="logout()">
        <ion-icon name="log-out" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <h2>Gestión de Presets</h2>

  <!-- Lista de presets como cards -->
  @if (presets().length === 0) {
    <ion-card>
      <ion-card-content class="ion-text-center">
        <p>No hay presets. Crea uno para empezar.</p>
      </ion-card-content>
    </ion-card>
  } @else {
    @for (preset of presets(); track preset.id) {
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ preset.name }}</ion-card-title>
          <ion-card-subtitle>{{ preset.bpm }} BPM • {{ preset.timeSignature }}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
            <ion-chip>
              <ion-label>
                @switch (preset.soundType) {
                  @case ('click') { Click }
                  @case ('beep') { Beep }
                  @case ('wood') { Madera }
                }
              </ion-label>
            </ion-chip>
            @if (preset.accentFirst) {
              <ion-chip color="success">
                <ion-label>Acento</ion-label>
              </ion-chip>
            }
          </div>
          <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <ion-button fill="outline" size="small" (click)="openEditModal(preset)">
              <ion-icon name="pencil" slot="start"></ion-icon>
              Editar
            </ion-button>
            <ion-button fill="outline" size="small" color="danger" (click)="deletePreset(preset)">
              <ion-icon name="trash" slot="start"></ion-icon>
              Eliminar
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    }
  }

  <!-- Botón flotante para crear preset -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openCreateModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>

<!-- Modal para crear/editar preset -->
<ion-modal [isOpen]="isCreating() || isEditing()" (didDismiss)="closeModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ isEditing() ? 'Editar Preset' : 'Nuevo Preset' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <form (ngSubmit)="savePreset()">
        <ion-list>
          <!-- Nombre -->
          <ion-item>
            <ion-input
              label="Nombre"
              label-placement="floating"
              type="text"
              placeholder="Ej: Rock básico"
              [(ngModel)]="formName"
              name="name"
              required>
            </ion-input>
          </ion-item>

          <!-- BPM -->
          <ion-item>
            <ion-label>BPM: {{ formBpm() }}</ion-label>
          </ion-item>
          <ion-item lines="none">
            <ion-range
              [min]="40"
              [max]="240"
              [value]="formBpm()"
              [pin]="true"
              (ionChange)="formBpm.set($any($event.detail.value))"
              color="primary">
            </ion-range>
          </ion-item>

          <!-- Compás -->
          <ion-item>
            <ion-label>Compás</ion-label>
            <ion-select
              slot="end"
              [value]="formTimeSignature()"
              (ionChange)="formTimeSignature.set($any($event.detail.value))">
              @for (ts of timeSignatures; track ts) {
                <ion-select-option [value]="ts">{{ ts }}</ion-select-option>
              }
            </ion-select>
          </ion-item>

          <!-- Sonido -->
          <ion-item>
            <ion-label>Tipo de sonido</ion-label>
            <ion-select
              slot="end"
              [value]="formSoundType()"
              (ionChange)="formSoundType.set($any($event.detail.value))">
              <ion-select-option value="click">Click</ion-select-option>
              <ion-select-option value="beep">Beep</ion-select-option>
              <ion-select-option value="wood">Madera</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Acentuar primer tiempo -->
          <ion-item>
            <ion-label>Acentuar primer tiempo</ion-label>
            <ion-toggle
              slot="end"
              [checked]="formAccentFirst()"
              (ionChange)="formAccentFirst.set($any($event.detail.checked))">
            </ion-toggle>
          </ion-item>
        </ion-list>

        <!-- Botones -->
        <div class="ion-padding-top">
          <ion-button expand="block" type="submit" color="primary">
            {{ isEditing() ? 'Guardar' : 'Crear' }}
          </ion-button>
          <ion-button expand="block" fill="outline" type="button" (click)="closeModal()">
            Cancelar
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
